<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - DVS</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <script>
      (async function gate() {
        const saved = localStorage.getItem("adminPass") || "";
        if (!saved) {
          window.location.replace("/admin-login.html");
          return;
        }
        // Validate password with a lightweight protected call
        try {
          const resp = await fetch(`${location.origin}/api/admin/tutors`, {
            headers: { "x-admin-password": saved },
          });
          if (!resp.ok) {
            window.location.replace("/admin-login.html");
          }
        } catch (e) {
          // If network error, stay but controls will fail gracefully
        }
      })();
    </script>
    <header>
      <div class="container">
        <nav>
          <a href="/">Home</a>
          <a href="/tutor.html">Tutor Sign-Up</a>
          <a href="/student.html">Register Student</a>
          <a href="/class-record.html">Class Record</a>
        </nav>
      </div>
    </header>
    <div class="container">
      <h1>Admin</h1>

      <section>
        <h2>Download Records</h2>
        <label>Filter Tutor<select id="adTutor"></select></label>
        <div class="row">
          <label style="flex: 1">From<input type="date" id="adFrom" /></label>
          <label style="flex: 1">To<input type="date" id="adTo" /></label>
        </div>
        <button onclick="downloadCSV()">Download CSV</button>
        <button onclick="downloadStudentSummaryCSV()" style="margin-left: 8px">
          Download Student Summary CSV
        </button>
      </section>

      <section>
        <h2>Pending Approvals</h2>
        <div id="pendingRecords"></div>
      </section>

      <section style="margin-top: 16px">
        <h2>Approve Late Submission</h2>
        <label>Record ID<input id="lateRecordId" /></label>
        <label>Admin Name<input id="lateAdminName" /></label>
        <label>Notes<input id="lateNotes" /></label>
        <button onclick="approveLate()">Approve Late</button>
        <div id="adminMsg" class="muted"></div>
      </section>

      <section style="margin-top: 16px">
        <h2>Records</h2>
        <!-- <div class="row">
          <button onclick="loadRecords()">Refresh</button>
          <button onclick="downloadCSV()">Download Displayed CSV</button>
        </div> -->
        <div class="row" style="margin-bottom: 10px">
          <button onclick="loadRecords()">Refresh</button>
          <button onclick="downloadCSV()">Download Displayed CSV</button>
          <button onclick="bulkDelete()" class="danger">Delete Selected</button>
        </div>
        <div style="overflow: auto; margin-top: 10px">
          <table id="recordsTable">
            <thead>
              <tr>
                <th>
                  <input
                    type="checkbox"
                    id="selectAll"
                    onclick="toggleSelectAll()"
                  />
                </th>
                <th>Date</th>
                <th>Tutor</th>
                <th>Student</th>
                <th>Class</th>
                <th>Subject</th>
                <th>Topic</th>
                <th>Start</th>
                <th>End</th>
                <th>Amount (â‚¦)</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <div id="editModal" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="editModalTitle"
      >
        <h3 id="editModalTitle">Edit Class Record</h3>
        <form id="editForm" onsubmit="return false;">
          <input type="hidden" id="editRecordId" />
          <div class="row">
            <label style="flex: 1"
              >Tutor
              <select id="editTutor"></select>
            </label>
            <label style="flex: 1"
              >Student
              <select id="editStudent"></select>
            </label>
          </div>

          <div class="row">
            <label style="flex: 1"
              >Class
              <select id="editClass"></select>
            </label>
            <label style="flex: 1"
              >Subject
              <select id="editSubject"></select>
            </label>
          </div>

          <label
            >Topic
            <input id="editTopic" />
          </label>

          <div class="row">
            <label style="flex: 1"
              >Start
              <input type="datetime-local" id="editStart" />
            </label>
            <label style="flex: 1"
              >End
              <input type="datetime-local" id="editEnd" />
            </label>
          </div>

          <label
            >Comment
            <input id="editComment" />
          </label>

          <div style="display: flex; gap: 8px; margin-top: 12px">
            <button type="button" onclick="saveEdit()">Save</button>
            <button type="button" onclick="closeEditModal()" class="muted">
              Cancel
            </button>
          </div>

          <div id="editMsg" class="muted"></div>
        </form>
      </div>
    </div>

    <script>
      const api = (path) => `${location.origin}/api${path}`;
      const getPass = () => localStorage.getItem("adminPass") || "";
      async function loadTutors() {
        const tutorsResp = await fetch(api("/admin/tutors"), {
          headers: { "x-admin-password": getPass() },
        });
        if (!tutorsResp.ok) {
          document.getElementById("adTutor").innerHTML = "";
          return;
        }
        const tutors = await tutorsResp.json();
        const adTutor = document.getElementById("adTutor");
        adTutor.innerHTML =
          '<option value="">All Tutors</option>' +
          tutors
            .map((t) => `<option value="${t._id}">${t.name}</option>`)
            .join("");
      }
      // async function downloadCSV() {
      //   const tutorId = document.getElementById('adTutor').value;
      //   const from = document.getElementById('adFrom').value;
      //   const to = document.getElementById('adTo').value;
      //   const url = new URL(api('/admin/export'));
      //   url.searchParams.set('adminPassword', getPass());
      //   if (tutorId) url.searchParams.set('tutorId', tutorId);
      //   if (from) url.searchParams.set('from', from);
      //   if (to) url.searchParams.set('to', to);
      //   const a = document.createElement('a');
      //   a.href = url.toString();
      //   a.click();
      // }
      async function downloadCSV() {
        const tutorId = document.getElementById("adTutor").value;
        const from = document.getElementById("adFrom").value;
        const to = document.getElementById("adTo").value;
        const url = new URL(api("/admin/export"));
        if (tutorId) url.searchParams.set("tutorId", tutorId);
        if (from) url.searchParams.set("from", from);
        if (to) url.searchParams.set("to", to);

        const res = await fetch(url.toString(), {
          headers: { "x-admin-password": getPass() },
        });
        if (!res.ok) {
          document.getElementById("adminMsg").textContent = "Export failed";
          return;
        }
        const blob = await res.blob();
        const filename = `records${from ? "-" + from : ""}${
          to ? "-" + to : ""
        }.csv`;
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      }
      // async function downloadStudentSummaryCSV() {
      //   const tutorId = document.getElementById('adTutor').value;
      //   const from = document.getElementById('adFrom').value;
      //   const to = document.getElementById('adTo').value;
      //   const url = new URL(api('/admin/export-student-summary'));
      //   url.searchParams.set('adminPassword', getPass());
      //   if (tutorId) url.searchParams.set('tutorId', tutorId);
      //   if (from) url.searchParams.set('from', from);
      //   if (to) url.searchParams.set('to', to);
      //   const a = document.createElement('a');
      //   a.href = url.toString();
      //   a.click();
      // }
      async function downloadStudentSummaryCSV() {
        const tutorId = document.getElementById("adTutor").value;
        const from = document.getElementById("adFrom").value;
        const to = document.getElementById("adTo").value;
        const url = new URL(api("/admin/export-student-summary"));
        if (tutorId) url.searchParams.set("tutorId", tutorId);
        if (from) url.searchParams.set("from", from);
        if (to) url.searchParams.set("to", to);

        const res = await fetch(url.toString(), {
          headers: { "x-admin-password": getPass() },
        });
        if (!res.ok) {
          document.getElementById("adminMsg").textContent = "Export failed";
          return;
        }
        const blob = await res.blob();
        const filename = `student-summary${from ? "-" + from : ""}${
          to ? "-" + to : ""
        }.csv`;
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      }
      async function approveLate() {
        const recordId = document.getElementById("lateRecordId").value.trim();
        const adminName = document.getElementById("lateAdminName").value.trim();
        const notes = document.getElementById("lateNotes").value.trim();
        const res = await fetch(api(`/admin/late-approve/${recordId}`), {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-admin-password": getPass(),
          },
          body: JSON.stringify({ adminName, notes }),
        });
        const out = await res.json();
        document.getElementById("adminMsg").textContent = res.ok
          ? "Late approved"
          : out.message;
      }
      async function loadRecords() {
        const tutorId = document.getElementById("adTutor").value;
        const from = document.getElementById("adFrom").value;
        const to = document.getElementById("adTo").value;
        const params = new URLSearchParams();
        if (tutorId) params.set("tutorId", tutorId);
        if (from) params.set("from", from);
        if (to) params.set("to", to);
        const resp = await fetch(api(`/class-records?${params.toString()}`));
        if (!resp.ok) return;
        const rows = await resp.json();
        const tbody = document.querySelector("#recordsTable tbody");
        tbody.innerHTML = rows
          .map(
            (r) => `
      <tr data-id="${r._id}">
        <td><input type="checkbox" class="record-select" value="${r._id}"></td>
        <td>${new Date(r.dateSubmitted).toLocaleDateString()}</td>
        <td>${r.tutorId?.name || ""}</td>
        <td>${r.studentId?.name || ""}</td>
        <td>${r.classLevel}</td>
        <td>${r.subject}</td>
        <td>${r.topic}</td>
        <td>${new Date(r.startTime).toLocaleString()}</td>
        <td>${new Date(r.endTime).toLocaleString()}</td>
        <td>${(r.paymentAmount || 0).toLocaleString()}</td>
        <td>${r.status}</td>
        <td>
          <button onclick="editRecord('${r._id}')" class="small">Edit</button>
          <button onclick="deleteRecord('${
            r._id
          }')" class="small danger">Delete</button>
        </td>
      </tr>
    `
          )
          .join("");
      }
      function toggleSelectAll() {
        const selectAll = document.getElementById("selectAll");
        const checkboxes = document.querySelectorAll(".record-select");
        checkboxes.forEach(
          (checkbox) => (checkbox.checked = selectAll.checked)
        );
      }

      async function bulkDelete() {
        const selected = Array.from(
          document.querySelectorAll(".record-select:checked")
        ).map((checkbox) => checkbox.value);

        if (!selected.length) {
          document.getElementById("adminMsg").textContent =
            "No records selected";
          return;
        }

        if (!confirm(`Delete ${selected.length} selected records?`)) return;

        try {
          const res = await fetch(api("/class-records/bulk-delete"), {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              "x-admin-password": getPass(),
            },
            body: JSON.stringify({ ids: selected }),
          });

          if (res.ok) {
            document.getElementById("adminMsg").textContent =
              "Records deleted successfully";
            loadRecords();
          } else {
            const data = await res.json();
            document.getElementById("adminMsg").textContent =
              data.message || "Delete failed";
          }
        } catch (err) {
          document.getElementById("adminMsg").textContent = "Network error";
        }
      }

      async function bulkDelete() {
        const selected = Array.from(
          document.querySelectorAll(".record-select:checked")
        ).map((checkbox) => checkbox.value);

        if (!selected.length) {
          document.getElementById("adminMsg").textContent =
            "No records selected";
          return;
        }

        if (!confirm(`Delete ${selected.length} selected records?`)) return;

        try {
          const res = await fetch(api("/class-records/bulk-delete"), {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              "x-admin-password": getPass(),
            },
            body: JSON.stringify({ ids: selected }),
          });

          if (res.ok) {
            document.getElementById("adminMsg").textContent =
              "Records deleted successfully";
            loadRecords();
          } else {
            const data = await res.json();
            document.getElementById("adminMsg").textContent =
              data.message || "Delete failed";
          }
        } catch (err) {
          document.getElementById("adminMsg").textContent = "Network error";
        }
      }

      async function deleteRecord(id) {
        if (!confirm("Delete this record?")) return;

        try {
          const res = await fetch(api(`/class-records/${id}`), {
            method: "DELETE",
            headers: { "x-admin-password": getPass() },
          });

          if (res.ok) {
            document.getElementById("adminMsg").textContent = "Record deleted";
            loadRecords();
          } else {
            const data = await res.json();
            document.getElementById("adminMsg").textContent =
              data.message || "Delete failed";
          }
        } catch (err) {
          document.getElementById("adminMsg").textContent = "Network error";
        }
      }
      function showEditModal() {
        const m = document.getElementById("editModal");
        m.style.display = "flex";
        m.setAttribute("aria-hidden", "false");
      }

      function closeEditModal() {
        const m = document.getElementById("editModal");
        m.style.display = "none";
        m.setAttribute("aria-hidden", "true");
        document.getElementById("editMsg").textContent = "";
      }

      async function openEditModal(recordId) {
        document.getElementById("editMsg").textContent = "";
        document.getElementById("editRecordId").value = recordId;

        // load tutors & students (for selects)
        const [tutorsResp, studentsResp] = await Promise.all([
          fetch(api("/tutors")),
          fetch(api("/students")),
        ]);
        const tutors = tutorsResp.ok ? await tutorsResp.json() : [];
        const students = studentsResp.ok ? await studentsResp.json() : [];

        const editTutor = document.getElementById("editTutor");
        editTutor.innerHTML =
          '<option value="">Select Tutor</option>' +
          tutors
            .map((t) => `<option value="${t._id}">${t.name}</option>`)
            .join("");

        const editStudent = document.getElementById("editStudent");
        editStudent.innerHTML =
          '<option value="">Select Student</option>' +
          students
            .map((s) => `<option value="${s._id}">${s.name}</option>`)
            .join("");

        // class options
        const classSel = document.getElementById("editClass");
        classSel.innerHTML = [
          "Nursery",
          ...Array.from({ length: 12 }, (_, i) => `Year ${i + 1}`),
        ]
          .map((c) => `<option>${c}</option>`)
          .join("");

        // fetch the record
        const resp = await fetch(api(`/class-records/${recordId}`));
        if (!resp.ok) {
          document.getElementById("adminMsg").textContent =
            "Failed to load record";
          return;
        }
        const r = await resp.json();

        // populate form
        editTutor.value = r.tutorId?._id || "";
        editStudent.value = r.studentId?._id || "";
        document.getElementById("editClass").value = r.classLevel || "";

        // populate subject options for selected tutor
        const tutorObj = tutors.find((t) => t._id === (r.tutorId?._id || ""));
        const editSubject = document.getElementById("editSubject");
        editSubject.innerHTML = tutorObj
          ? tutorObj.subjects.map((s) => `<option>${s}</option>`).join("")
          : "<option></option>";
        document.getElementById("editSubject").value = r.subject || "";

        document.getElementById("editTopic").value = r.topic || "";
        document.getElementById("editStart").value = toDatetimeLocalValue(
          r.startTime
        );
        document.getElementById("editEnd").value = toDatetimeLocalValue(
          r.endTime
        );
        document.getElementById("editComment").value = r.comment || "";

        // update subject options when tutor changes (replace handler to avoid duplicates)
        editTutor.onchange = () => {
          const t = tutors.find((x) => x._id === editTutor.value);
          editSubject.innerHTML = t
            ? t.subjects.map((s) => `<option>${s}</option>`).join("")
            : "";
        };

        showEditModal();
      }

      async function editRecord(id) {
        // open modal instead of redirect
        openEditModal(id);
      }

      async function saveEdit() {
        const id = document.getElementById("editRecordId").value;
        const tutorId = document.getElementById("editTutor").value;
        const studentId = document.getElementById("editStudent").value;
        const classLevel = document.getElementById("editClass").value;
        const subject = document.getElementById("editSubject").value;
        const topic = document.getElementById("editTopic").value;
        const startTime = document.getElementById("editStart").value;
        const endTime = document.getElementById("editEnd").value;
        const comment = document.getElementById("editComment").value;

        if (
          !tutorId ||
          !studentId ||
          !classLevel ||
          !subject ||
          !topic ||
          !startTime ||
          !endTime
        ) {
          document.getElementById("editMsg").textContent =
            "All fields are required";
          return;
        }

        const s = new Date(startTime);
        const e = new Date(endTime);
        if (isNaN(s.getTime()) || isNaN(e.getTime()) || e <= s) {
          document.getElementById("editMsg").textContent =
            "Invalid start/end times";
          return;
        }

        const minutes = (e.getTime() - s.getTime()) / 60000;
        const allowed = [30, 60, 90, 120];
        if (!allowed.includes(minutes)) {
          document.getElementById("editMsg").textContent =
            "Allowed durations: 30m, 1h, 1.5h, 2h";
          return;
        }

        const rate = getRateLocal(classLevel);
        const paymentAmount = Math.round(rate * (minutes / 60));

        try {
          const res = await fetch(api(`/class-records/${id}`), {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "x-admin-password": getPass(),
            },
            body: JSON.stringify({
              tutorId,
              studentId,
              classLevel,
              subject,
              topic,
              startTime,
              endTime,
              comment,
              paymentAmount,
            }),
          });

          if (!res.ok) {
            const out = await res.json().catch(() => ({}));
            document.getElementById("editMsg").textContent =
              out.message || "Update failed";
            return;
          }

          closeEditModal();
          document.getElementById("adminMsg").textContent = "Record updated";
          loadRecords();
        } catch (err) {
          console.error(err);
          document.getElementById("editMsg").textContent = "Network error";
        }
      }

      document.getElementById("editModal").addEventListener("click", (e) => {
        if (e.target.id === "editModal") closeEditModal();
      });
      async function loadPendingRecords() {
        const resp = await fetch(api("/class-records/pending"), {
          headers: { "x-admin-password": getPass() },
        });
        if (!resp.ok) return;

        const records = await resp.json();
        const container = document.getElementById("pendingRecords");

        container.innerHTML =
          records
            .map(
              (record) => `
    <div class="pending-record">
      <p>Tutor: ${record.tutorId.name}</p>
      <p>Student: ${record.studentId.name}</p>
      <p>Date: ${new Date(record.startTime).toLocaleDateString()}</p>
      <p>Reason: ${record.approvalRequest.reason}</p>
      <button onclick="handleApproval('${record._id}', true)">Approve</button>
      <button onclick="handleApproval('${record._id}', false)">Reject</button>
    </div>
  `
            )
            .join("") || "<p>No pending approvals</p>";
      }

      async function handleApproval(recordId, approved) {
        const resp = await fetch(api(`/class-records/${recordId}/approve`), {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "x-admin-password": getPass(),
          },
          body: JSON.stringify({
            adminId: localStorage.getItem("adminId"),
            approved,
          }),
        });

        if (resp.ok) {
          loadPendingRecords();
          document.getElementById("adminMsg").textContent = `Record ${
            approved ? "approved" : "rejected"
          } successfully`;
        }
      }

      loadTutors();
      loadRecords();
      loadPendingRecords();
    </script>
  </body>
</html>
